# Система освещения Darkfall Depths

## Обзор

Новая система освещения в Darkfall Depths обеспечивает реалистичное освещение с множественными источниками света, цветным освещением и динамическими эффектами, как в Terraria.

## Основные компоненты

### 1. LightingSystem (js/map/LightingSystem.js)
Основной класс системы освещения, который управляет:
- Множественными источниками света
- Картой освещения для каждого тайла
- WebGL шейдерами для производительного рендеринга
- Fallback на Canvas 2D для совместимости

### 2. LightSource (js/entities/LightSource.js)
Класс для светящихся объектов на карте:
- Факелы (временные источники с топливом)
- Магические сферы (постоянные источники)
- Кристаллы (постоянные источники с пульсацией)
- Огни (временные источники с мерцанием)

### 3. Интеграция с генератором карты
MapGenerator теперь создает источники света:
- **Факелы на стенах комнат** - размещаются в углах и серединах стен
- **Чаши с огнем в центре комнат** - на постаментах для освещения
- **Умная система факелов в коридорах** - через равные промежутки (6 тайлов) только в длинных коридорах (8+ тайлов)
- **Декоративные источники света** - редкие магические сферы и кристаллы в больших комнатах

## Типы источников света

### TORCH (Факел)
- **Радиус**: 4 тайла
- **Цвет**: Оранжевый [1.0, 0.6, 0.2]
- **Интенсивность**: 0.8
- **Мерцание**: 0.1
- **Тип**: Временный (с топливом)

### MAGIC_ORB (Магическая сфера)
- **Радиус**: 6 тайлов
- **Цвет**: Синий [0.2, 0.6, 1.0]
- **Интенсивность**: 0.9
- **Мерцание**: 0.05
- **Пульсация**: 0.2
- **Тип**: Постоянный

### CRYSTAL (Кристалл)
- **Радиус**: 5 тайлов
- **Цвет**: Фиолетовый [0.8, 0.2, 1.0]
- **Интенсивность**: 0.7
- **Пульсация**: 0.3
- **Тип**: Постоянный

### FIRE (Огонь)
- **Радиус**: 3 тайла
- **Цвет**: Красный [1.0, 0.3, 0.1]
- **Интенсивность**: 0.6
- **Мерцание**: 0.2
- **Тип**: Временный

### PLAYER_LIGHT (Свет игрока)
- **Радиус**: 8 тайлов
- **Цвет**: Теплый белый [1.0, 1.0, 0.8]
- **Интенсивность**: 0.5
- **Тип**: Постоянный (следует за игроком)

## Технические особенности

### WebGL рендеринг
- Специальные шейдеры для освещения
- Градиентные круги света
- Режим наложения 'screen' для реалистичного эффекта
- Оптимизированная производительность

### Canvas 2D fallback
- Радиальные градиенты для источников света
- Совместимость со старыми браузерами
- Меньшая производительность, но полная совместимость

### Интеграция с туманом войны
- Источники света влияют на видимость в тумане войны
- Комбинированное освещение от игрока и источников
- Динамическое обновление видимости

## Использование

### Добавление источника света в коде:
```javascript
import { LightSourceFactory } from './js/entities/LightSource.js';

// Создание факела
const torch = LightSourceFactory.createTorch(x, y, false);

// Создание магической сферы
const orb = LightSourceFactory.createMagicOrb(x, y, true);

// Добавление в игровое состояние
gameState.lightSources.push(torch);
```

### Управление источниками света:
```javascript
// Активация/деактивация
lightSource.activate();
lightSource.deactivate();

// Добавление топлива (для временных источников)
lightSource.addFuel(50);

// Подбор источника света
const item = lightSource.pickup();
```

## Производительность

### Оптимизации:
- Обновление источников света каждые 100мс
- Кэширование карты освещения
- Отрисовка только видимых источников
- WebGL рендеринг для максимальной производительности

### Мониторинг:
- FPS индикатор показывает производительность
- Автоматическое переключение на Canvas 2D при низкой производительности
- Оптимизированные алгоритмы обновления

## Тестирование

Для тестирования системы освещения используйте файл `test_lighting.html`:
1. Откройте файл в браузере
2. Используйте кнопки для добавления различных источников света
3. Наблюдайте за эффектами освещения и анимацией

## Будущие улучшения

### Планируемые функции:
- Освещение от заклинаний и способностей
- Динамические тени от объектов
- Освещение от взрывов и эффектов
- Настройки качества освещения
- Освещение от врагов (огненные демоны и т.д.)

### Оптимизации:
- Многопоточная обработка освещения
- LOD система для больших карт
- Предварительно рассчитанные карты освещения
- GPU-ускоренные вычисления

## Совместимость

### Поддерживаемые браузеры:
- Chrome 60+ (WebGL 2.0)
- Firefox 55+ (WebGL 2.0)
- Safari 12+ (WebGL 1.0)
- Edge 79+ (WebGL 2.0)

### Fallback:
- Canvas 2D для старых браузеров
- Упрощенное освещение без WebGL
- Сохранение функциональности

## Интеграция с игровым процессом

### Геймплейные механики:
- **Факелы на стенах** - временные источники света, которые можно подбирать
- **Чаши с огнем** - постоянные источники света в центре комнат
- **Магические сферы и кристаллы** - декоративные элементы интерьера (не подбираются)
- **Умное освещение коридоров** - факелы размещаются через равные промежутки для навигации
- **Стратегическое освещение** - игрок может использовать факелы для создания безопасных зон

### Экономика:
- Факелы как расходуемые предметы
- Магические сферы как редкие находки
- Кристаллы как декоративные элементы
- Топливо для временных источников
