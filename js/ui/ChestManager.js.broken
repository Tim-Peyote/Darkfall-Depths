/* Darkfall Depths - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É–Ω–¥—É–∫–∞–º–∏ - Updated v3 - Fixed */

import { gameState } from '../core/GameState.js';

export class ChestManager {
  static currentChest = null;
  static isOpen = false;
  
  static init() {
    this.createChestUI();
    this.setupEventListeners();
  }
  
  static createChestUI() {
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å—É–Ω–¥—É–∫–∞
    const chestHTML = `
      <div id="chestOverlay" class="chest-overlay hidden">
        <div class="chest-modal">
          <div class="chest-header">
            <h3>–°—É–Ω–¥—É–∫</h3>
            <button id="closeChest" class="close-btn">‚úï</button>
          </div>
          <div class="chest-content">
            <div class="chest-inventory">
              <div class="chest-slots">
                <!-- –°–ª–æ—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ body –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!document.getElementById('chestOverlay')) {
      document.body.insertAdjacentHTML('beforeend', chestHTML);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSS —Å—Ç–∏–ª–∏
    this.addChestStyles();
  }
  
  static addChestStyles() {
    if (document.getElementById('chest-styles')) return;
    
    const styles = `
      <style id="chest-styles">
        .chest-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          backdrop-filter: blur(2px);
        }
        
        .chest-modal {
          background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
          border: 2px solid #8B4513;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
          min-width: 400px;
          max-width: 600px;
          max-height: 80vh;
          overflow: hidden;
        }
        
        .chest-header {
          background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
          color: #fff;
          padding: 15px 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 2px solid #654321;
        }
        
        .chest-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: bold;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .close-btn {
          background: #e74c3c;
          color: white;
          border: none;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          font-size: 16px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .close-btn:hover {
          background: #c0392b;
          transform: scale(1.1);
        }
        
        .chest-content {
          padding: 20px;
        }
        
        .chest-inventory {
          margin-bottom: 20px;
        }
        
        .chest-slots {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 10px;
          margin-bottom: 15px;
        }
        
        .chest-slot {
          width: 60px;
          height: 60px;
          border: 2px solid #8B4513;
          border-radius: 8px;
          background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
          display: flex;
          justify-content: center;
          align-items: center;
          cursor: pointer;
          transition: all 0.2s ease;
          position: relative;
        }
        
        .chest-slot:hover {
          border-color: #FFD700;
          transform: scale(1.05);
          box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .chest-slot.empty {
          border-color: #654321;
          background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }
        
        .chest-slot.empty::after {
          content: '';
          width: 20px;
          height: 20px;
          background: #7f8c8d;
          border-radius: 50%;
          opacity: 0.3;
        }
        
        .chest-slot .item-icon {
          font-size: 24px;
          filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.5));
        }
        
        .chest-slot .item-tooltip {
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          white-space: nowrap;
          z-index: 1001;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.2s ease;
        }
        
        .chest-slot:hover .item-tooltip {
          opacity: 1;
        }
        
        .chest-info {
          background: rgba(139, 69, 19, 0.2);
          border: 1px solid #8B4513;
          border-radius: 8px;
          padding: 15px;
          text-align: center;
        }
        
        .chest-info p {
          margin: 5px 0;
          color: #bdc3c7;
          font-size: 14px;
        }
        
        .hidden {
          display: none !important;
        }
        
        @media (max-width: 768px) {
          .chest-modal {
            min-width: 90vw;
            max-width: 90vw;
          }
          
          .chest-slots {
            grid-template-columns: repeat(4, 1fr);
          }
          
          .chest-slot {
            width: 50px;
            height: 50px;
          }
        }
      </style>
    `;
    
    document.head.insertAdjacentHTML('beforeend', styles);
  }
  
  static setupEventListeners() {
    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    document.addEventListener('click', (e) => {
      if (e.target.id === 'closeChest') {
        this.closeChest();
      }
    });
    
    // ESC –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Escape' && this.isOpen) {
        this.closeChest();
      }
    });
    
    // –ö–ª–∏–∫ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
    document.addEventListener('click', (e) => {
      if (e.target.id === 'chestOverlay') {
        this.closeChest();
      }
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –ª—é–±—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö –∏–≥—Ä–æ–∫–∞
    document.addEventListener('keydown', async (e) => {
      if (e.code === 'KeyE' && this.isOpen) {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ E –≤–æ –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Å—É–Ω–¥—É–∫–∞
        try {
          const { Chest } = await import('../entities/Chest.js');
          Chest.hideAllInteractionHints();
        } catch (e) {
          console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏:', e);
        }
      }
    });
  }
  
  static async openChest(chest) {
    // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —ç—Ç–æ—Ç –∂–µ —Å—É–Ω–¥—É–∫, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    if (this.isOpen && this.currentChest === chest) {
      await this.updateChestDisplay();
      return;
    }
    
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥—Ä—É–≥–æ–π —Å—É–Ω–¥—É–∫, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
    if (this.isOpen && this.currentChest !== chest) {
      this.closeChest();
    }
    
    this.currentChest = chest;
    this.isOpen = true;
    
    // –°—Ç–∞–≤–∏–º –∏–≥—Ä—É –Ω–∞ –ø–∞—É–∑—É
    gameState.isPaused = true;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    const hint = document.getElementById('interactionHint');
    if (hint && hint.classList.contains('active')) {
      hint.classList.add('hidden');
      hint.classList.remove('active');
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI
    const overlay = document.getElementById('chestOverlay');
    overlay.classList.remove('hidden');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—É–Ω–¥—É–∫–∞
    const header = overlay.querySelector('.chest-header h3');
    if (header) {
      const itemCount = this.currentChest.inventory.filter(item => item !== null).length;
      header.textContent = `–°—É–Ω–¥—É–∫ (${itemCount}/${this.currentChest.maxSlots})`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    await this.updateChestDisplay();
    
    // –§–æ–∫—É—Å –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    setTimeout(() => {
      const modal = overlay.querySelector('.chest-modal');
      if (modal) modal.focus();
    }, 100);
  }
  
  static closeChest() {
    if (!this.isOpen) return;
    
    this.isOpen = false;
    this.currentChest = null;
    
    // –°–∫—Ä—ã–≤–∞–µ–º UI
    const overlay = document.getElementById('chestOverlay');
    overlay.classList.add('hidden');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—É–Ω–¥—É–∫–∞
    const hint = document.getElementById('interactionHint');
    if (hint && hint.classList.contains('active')) {
      hint.classList.add('hidden');
      hint.classList.remove('active');
    }
    
    // –°–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã ESC –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª —Å—Ä–∞–∑—É
    setTimeout(() => {
      gameState.isPaused = false;
    }, 100);
  }
  
  static async updateChestDisplay() {
    const slotsContainer = document.querySelector('.chest-slots');
    if (!slotsContainer || !this.currentChest) return;
    
    slotsContainer.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —Å–µ—Ç–∫—É 4x4 (16 —Å–ª–æ—Ç–æ–≤)
    for (let i = 0; i < this.currentChest.maxSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'chest-slot';
      slot.dataset.index = i;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–º–µ—Ç –≤ —ç—Ç–æ–º —Å–ª–æ—Ç–µ
      const item = this.currentChest.inventory[i];
      
      // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π
      if (!item) {
        slot.innerHTML = '<div class="empty-slot">–ü—É—Å—Ç–æ</div>';
        slot.style.opacity = '0.3';
      } else {
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø—Ä–∞–π—Ç—ã –∏–∑ InventorySpriteRenderer
        if (item.base) {
          try {
            const { InventorySpriteRenderer } = await import('./InventorySpriteRenderer.js');
            const sprite = InventorySpriteRenderer.renderItemSprite(item.base, item.rarity || 'common', 48);
            
            // –°–æ–∑–¥–∞–µ–º img —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–ø—Ä–∞–π—Ç–∞
            const img = document.createElement('img');
            img.src = sprite.toDataURL();
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            
            slot.innerHTML = '';
            slot.appendChild(img);
          } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–π—Ç –ø—Ä–µ–¥–º–µ—Ç–∞:', e);
            slot.innerHTML = `<div class="item-icon">${item.icon || 'üì¶'}</div>`;
          }
        } else {
          slot.innerHTML = `<div class="item-icon">${item.icon || 'üì¶'}</div>`;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø
        slot.innerHTML += `<div class="item-tooltip">${item.name || '–ü—Ä–µ–¥–º–µ—Ç'}</div>`;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –≤–∑—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
        slot.addEventListener('dblclick', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          await this.takeItem(i);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        slot.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.showContextMenu(e, i);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω–∞—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è —Ç—É–ª—Ç–∏–ø–∞ (–¥–µ—Å–∫—Ç–æ–ø)
        slot.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (item) {
            this.showTooltip(e, item);
          }
        });
        
        // –ú–æ–±–∏–ª—å–Ω—ã–µ touch –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        let longPressTimer = null;
        let lastClickTime = 0;
        
        // Touch start
        slot.addEventListener('touchstart', (e) => {
          e.preventDefault();
          touchStartTime = Date.now();
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          touchMoved = false;
          
          // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
          longPressTimer = setTimeout(() => {
            if (!touchMoved) {
              this.showContextMenu(e, i);
            }
          }, 500);
        }, { passive: false });
        
        // Touch move
        slot.addEventListener('touchmove', (e) => {
          const touch = e.touches[0];
          const deltaX = Math.abs(touch.clientX - touchStartX);
          const deltaY = Math.abs(touch.clientY - touchStartY);
          
          if (deltaX > 10 || deltaY > 10) {
            touchMoved = true;
            if (longPressTimer) {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          }
        }, { passive: false });
        
        // Touch end
        slot.addEventListener('touchend', async (e) => {
          e.preventDefault();
          
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          
          if (touchMoved) return;
          
          const touchEndTime = Date.now();
          const touchDuration = touchEndTime - touchStartTime;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
          if (touchEndTime - lastClickTime < 300) {
            // –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ - –±–µ—Ä–µ–º –ø—Ä–µ–¥–º–µ—Ç
            await this.takeItem(i);
            lastClickTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
          } else {
            // –û–¥–∏–Ω–∞—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É–ª—Ç–∏–ø
            if (touchDuration < 200 && item) {
              // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ touchstart
              const tooltipEvent = {
                touches: [{ clientX: touchStartX, clientY: touchStartY }],
                clientX: touchStartX,
                clientY: touchStartY
              };
              this.showTooltip(tooltipEvent, item);
            }
            lastClickTime = touchEndTime;
          }
        }, { passive: false });
      
      slotsContainer.appendChild(slot);
    }
  }
  
  static async takeItem(itemIndex) {
    if (!this.currentChest || itemIndex < 0 || itemIndex >= this.currentChest.maxSlots) {
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ª–æ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
    if (itemIndex >= this.currentChest.inventory.length || !this.currentChest.inventory[itemIndex]) {
      return;
    }
    
    const item = this.currentChest.takeItem(itemIndex);
    if (item) {
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–≥—Ä–æ–∫–∞
      try {
        const { InventoryManager } = await import('./InventoryManager.js');
        const success = InventoryManager.addItemToInventory(item);
        if (success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          await this.updateChestDisplay();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—É–Ω–¥—É–∫–∞
          const overlay = document.getElementById('chestOverlay');
          const header = overlay.querySelector('.chest-header h3');
          if (header) {
            const itemCount = this.currentChest.inventory.filter(item => item !== null).length;
            header.textContent = `–°—É–Ω–¥—É–∫ (${itemCount}/${this.currentChest.maxSlots})`;
          }
          
          // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç
          this.playTakeItemSound();
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:', e);
      }
    }
  }
  
  static showTooltip(e, item) {
    // –°–æ–∑–¥–∞–µ–º —Ç—É–ª—Ç–∏–ø –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let tooltip = document.getElementById('chest-tooltip');
    if (!tooltip) {
      tooltip = document.createElement('div');
      tooltip.id = 'chest-tooltip';
      tooltip.style.cssText = `
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 10000;
        pointer-events: none;
        max-width: 250px;
        white-space: pre-wrap;
        border: 1px solid #666;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      `;
      document.body.appendChild(tooltip);
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    let clientX, clientY;
    if (e.touches && e.touches[0]) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥–º–µ—Ç–µ
    tooltip.textContent = `${item.name || '–ü—Ä–µ–¥–º–µ—Ç'}\n${item.description || ''}`;
    
    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ç—É–ª—Ç–∏–ø —Å —É—á–µ—Ç–æ–º –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞
    let left = clientX + 10;
    let top = clientY - 10;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ —Ç—É–ª—Ç–∏–ø –∑–∞ –ª–µ–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É
    if (left < 10) {
      left = 10; // –û—Ç—Å—Ç—É–ø –æ—Ç –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ —Ç—É–ª—Ç–∏–ø –∑–∞ –ø—Ä–∞–≤—É—é –≥—Ä–∞–Ω–∏—Ü—É
    if (left + 250 > window.innerWidth) {
      left = clientX - 260; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ —Ç—É–ª—Ç–∏–ø –∑–∞ –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
    if (top < 10) {
      top = clientY + 10; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ —Ç—É–ª—Ç–∏–ø –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
    if (top + 100 > window.innerHeight) {
      top = window.innerHeight - 110; // –û—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    // –ï—Å–ª–∏ —Ç—É–ª—Ç–∏–ø –≤—Å–µ –µ—â–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ª–µ–≤—ã–π –∫—Ä–∞–π –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
    if (left < 10) {
      left = 10;
    }
    
    // –ï—Å–ª–∏ —Ç—É–ª—Ç–∏–ø –≤—Å–µ –µ—â–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
    if (left + 250 > window.innerWidth - 10) {
      left = window.innerWidth - 260;
    }
    
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
    tooltip.style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      if (tooltip) {
        tooltip.style.display = 'none';
      }
    }, 3000);
  }
  
  static showContextMenu(e, itemIndex) {
    if (!this.currentChest || itemIndex < 0 || itemIndex >= this.currentChest.maxSlots) return;
    
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤
    if (itemIndex >= this.currentChest.inventory.length || !this.currentChest.inventory[itemIndex]) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–µ–Ω—é –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingMenu = document.querySelector('.chest-context-menu');
    if (existingMenu) {
      existingMenu.remove();
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    const contextMenu = document.createElement('div');
    contextMenu.className = 'chest-context-menu';
    contextMenu.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: #2c3e50;
      border: 1px solid #95a5a6;
      border-radius: 6px;
      padding: 5px 0;
      z-index: 1002;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    
    const takeOption = document.createElement('div');
    takeOption.textContent = '–í–∑—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
    takeOption.style.cssText = `
      padding: 8px 15px;
      cursor: pointer;
      color: #ecf0f1;
      font-size: 14px;
    `;
    takeOption.addEventListener('mouseenter', () => {
      takeOption.style.background = '#34495e';
    });
    takeOption.addEventListener('mouseleave', () => {
      takeOption.style.background = 'transparent';
    });
    takeOption.addEventListener('click', async () => {
      await this.takeItem(itemIndex);
      contextMenu.remove();
    });
    
    contextMenu.appendChild(takeOption);
    document.body.appendChild(contextMenu);
    
    // –£–¥–∞–ª—è–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    const removeMenu = (e) => {
      if (contextMenu && !contextMenu.contains(e.target)) {
        contextMenu.remove();
        document.removeEventListener('click', removeMenu);
      }
    };
    
    setTimeout(() => {
      document.addEventListener('click', removeMenu);
    }, 100);
  }
  
  static playTakeItemSound() {
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤–∑—è—Ç–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
    const audioManager = gameState.audioManager;
    if (audioManager) {
      audioManager.playSound('item_pickup');
    }
  }
  

}
// Version: 1755550355
